{"version":3,"sources":["../src/index.js"],"names":["tags","require","bytes","SOIMarkerLength","JPEGSOIMarker","TIFFINTEL","TIFFMOTOROLA","APPMarkerLength","APPMarkerBegin","APPMarkerEnd","data","isValid","buffer","SOIMarker","readUInt16BE","e","Error","isTiff","checkAPPn","APPMarkerTag","isInRange","IFDHandler","tagCollection","order","offset","entriesNumber","readUInt16LE","entriesNumberLength","entries","slice","entryLength","exif","entryCount","entryBegin","entry","tagBegin","tagLength","dataFormatBegin","dataFormatLength","componentsBegin","componentsNumberLength","dataValueBegin","dataValueLength","tagAddress","tagNumber","toString","reverse","tagName","bigDataFormat","littleDataFormat","dataFormat","componentsByte","bigComponentsNumber","readUInt32BE","littleComponentNumber","readUInt32LE","componentsNumber","dataLength","dataValue","dataOffset","tagValue","readUInt8","replace","i","length","bigTagValue","littleTagValue","push","bigOrder","readInt32BE","littleOrder","readInt32LE","EXIFHandler","buf","pad","lengthLength","identifierLength","padLength","byteOrderLength","byteOrder","fortyTwoLength","fortyTwoEnd","big42","little42","offsetOfIFD","ifd","ExifIFDPointer","SubExif","GPSInfoIFDPointer","gps","GPSInfo","APPnHandler","fromBuffer","undefined","sync","file","fs","readFileSync","async","callback","Promise","resolve","reject","readFile","err","error","then","d","catch","exports","parse","parseSync"],"mappings":"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","file":"index.js","sourcesContent":["import fs from 'fs';\r\n\r\nconst tags = require('./tags.json');\r\n\r\n/*\r\n unsignedByte,\r\n asciiStrings,\r\n unsignedShort,\r\n unsignedLong,\r\n unsignedRational,\r\n signedByte,\r\n undefined,\r\n signedShort,\r\n signedLong,\r\n signedRational,\r\n singleFloat,\r\n doubleFloat\r\n */\r\nconst bytes = [0, 1, 1, 2, 4, 8, 1, 1, 2, 4, 8, 4, 8];\r\nconst SOIMarkerLength = 2;\r\nconst JPEGSOIMarker = 0xffd8;\r\nconst TIFFINTEL = 0x4949;\r\nconst TIFFMOTOROLA = 0x4d4d;\r\nconst APPMarkerLength = 2;\r\nconst APPMarkerBegin = 0xffe0;\r\nconst APPMarkerEnd = 0xffef;\r\nlet data;\r\n/**\r\n * @param buffer {Buffer}\r\n * @returns {Boolean}\r\n * @example\r\n * var content = fs.readFileSync(\"~/Picture/IMG_0911.JPG\");\r\n * var isImage = isValid(content);\r\n * console.log(isImage);\r\n */\r\nconst isValid = (buffer) => {\r\n  try {\r\n    const SOIMarker = buffer.readUInt16BE(0);\r\n    return SOIMarker === JPEGSOIMarker;\r\n  } catch (e) {\r\n    throw new Error('Unsupport file format.');\r\n  }\r\n};\r\n/**\r\n * @param buffer {Buffer}\r\n * @returns {Boolean}\r\n * @example\r\n */\r\nconst isTiff = (buffer) => {\r\n  try {\r\n    const SOIMarker = buffer.readUInt16BE(0);\r\n    return SOIMarker === TIFFINTEL || SOIMarker === TIFFMOTOROLA;\r\n  } catch (e) {\r\n    throw new Error('Unsupport file format.');\r\n  }\r\n};\r\n/**\r\n * @param buffer {Buffer}\r\n * @returns {Number}\r\n * @example\r\n * var content = fs.readFileSync(\"~/Picture/IMG_0911.JPG\");\r\n * var APPNumber = checkAPPn(content);\r\n * console.log(APPNumber);\r\n */\r\nconst checkAPPn = (buffer) => {\r\n  try {\r\n    const APPMarkerTag = buffer.readUInt16BE(0);\r\n    const isInRange = APPMarkerTag >= APPMarkerBegin && APPMarkerTag <= APPMarkerEnd;\r\n    return isInRange ? APPMarkerTag - APPMarkerBegin : false;\r\n  } catch (e) {\r\n    throw new Error('Invalid APP Tag.');\r\n  }\r\n};\r\n/**\r\n * @param buffer {Buffer}\r\n * @param tagCollection {Object}\r\n * @param order {Boolean}\r\n * @param offset {Number}\r\n * @returns {Object}\r\n * @example\r\n * var content = fs.readFileSync(\"~/Picture/IMG_0911.JPG\");\r\n * var exifFragments = IFDHandler(content, 0, true, 8);\r\n * console.log(exifFragments.value);\r\n */\r\nconst IFDHandler = (buffer, tagCollection, order, offset) => {\r\n  const entriesNumber = order ? buffer.readUInt16BE(0) : buffer.readUInt16LE(0);\r\n\r\n  if (entriesNumber === 0) {\r\n    return {};\r\n  }\r\n\r\n  const entriesNumberLength = 2;\r\n  const entries = buffer.slice(entriesNumberLength);\r\n  const entryLength = 12;\r\n  // let nextIFDPointerBegin = entriesNumberLength + entryLength * entriesNumber;\r\n  // let bigNextIFDPointer= buffer.readUInt32BE(nextIFDPointerBegin) ;\r\n  // let littleNextIFDPointer= buffer.readUInt32LE(nextIFDPointerBegin);\r\n  // let nextIFDPointer = order ?bigNextIFDPointer:littleNextIFDPointer;\r\n  const exif = {};\r\n  let entryCount = 0;\r\n\r\n  for (entryCount; entryCount < entriesNumber; entryCount += 1) {\r\n    const entryBegin = entryCount * entryLength;\r\n    const entry = entries.slice(entryBegin, entryBegin + entryLength);\r\n    const tagBegin = 0;\r\n    const tagLength = 2;\r\n    const dataFormatBegin = tagBegin + tagLength;\r\n    const dataFormatLength = 2;\r\n    const componentsBegin = dataFormatBegin + dataFormatLength;\r\n    const componentsNumberLength = 4;\r\n    const dataValueBegin = componentsBegin + componentsNumberLength;\r\n    const dataValueLength = 4;\r\n    const tagAddress = entry.slice(tagBegin, dataFormatBegin);\r\n    const tagNumber = order ? tagAddress.toString('hex') : tagAddress.reverse().toString('hex');\r\n    const tagName = tagCollection[tagNumber];\r\n    const bigDataFormat = entry.readUInt16BE(dataFormatBegin);\r\n    const littleDataFormat = entry.readUInt16LE(dataFormatBegin);\r\n    const dataFormat = order ? bigDataFormat : littleDataFormat;\r\n    const componentsByte = bytes[dataFormat];\r\n    const bigComponentsNumber = entry.readUInt32BE(componentsBegin);\r\n    const littleComponentNumber = entry.readUInt32LE(componentsBegin);\r\n    const componentsNumber = order ? bigComponentsNumber : littleComponentNumber;\r\n    const dataLength = componentsNumber * componentsByte;\r\n    let dataValue = entry.slice(dataValueBegin, dataValueBegin + dataValueLength);\r\n\r\n    if (dataLength > 4) {\r\n      const dataOffset = (order ? dataValue.readUInt32BE(0) : dataValue.readUInt32LE(0)) - offset;\r\n      dataValue = buffer.slice(dataOffset, dataOffset + dataLength);\r\n    }\r\n\r\n    let tagValue;\r\n\r\n    if (tagName) {\r\n      switch (dataFormat) {\r\n        case 1:\r\n          tagValue = dataValue.readUInt8(0);\r\n          break;\r\n        case 2:\r\n          tagValue = dataValue.toString('ascii').replace(/\\0+$/, '');\r\n          break;\r\n        case 3:\r\n          tagValue = order ? dataValue.readUInt16BE(0) : dataValue.readUInt16LE(0);\r\n          break;\r\n        case 4:\r\n          tagValue = order ? dataValue.readUInt32BE(0) : dataValue.readUInt32LE(0);\r\n          break;\r\n        case 5:\r\n          tagValue = [];\r\n\r\n          for (let i = 0; i < dataValue.length; i += 8) {\r\n            const bigTagValue = dataValue.readUInt32BE(i) / dataValue.readUInt32BE(i + 4);\r\n            const littleTagValue = dataValue.readUInt32LE(i) / dataValue.readUInt32LE(i + 4);\r\n            tagValue.push(order ? bigTagValue : littleTagValue);\r\n          }\r\n\r\n          break;\r\n        case 7:\r\n          switch (tagName) {\r\n            case 'ExifVersion':\r\n              tagValue = dataValue.toString();\r\n              break;\r\n            case 'FlashPixVersion':\r\n              tagValue = dataValue.toString();\r\n              break;\r\n            case 'SceneType':\r\n              tagValue = dataValue.readUInt8(0);\r\n              break;\r\n            default:\r\n              tagValue = `0x${dataValue.toString('hex', 0, 15)}`;\r\n              break;\r\n          }\r\n          break;\r\n        case 10: {\r\n          const bigOrder = dataValue.readInt32BE(0) / dataValue.readInt32BE(4);\r\n          const littleOrder = dataValue.readInt32LE(0) / dataValue.readInt32LE(4);\r\n          tagValue = order ? bigOrder : littleOrder;\r\n          break;\r\n        }\r\n        default:\r\n          tagValue = `0x${dataValue.toString('hex')}`;\r\n          break;\r\n      }\r\n      exif[tagName] = tagValue;\r\n    }\r\n    /*\r\n     else {\r\n     console.log(`Unkown Tag [0x${tagNumber}].`);\r\n     }\r\n     */\r\n  }\r\n  return exif;\r\n};\r\n\r\n/**\r\n * @param buf {Buffer}\r\n * @returns {Undefined}\r\n * @example\r\n * var content = fs.readFileSync(\"~/Picture/IMG_0911.JPG\");\r\n * var exifFragments = EXIFHandler(content);\r\n */\r\nconst EXIFHandler = (buf, pad = true) => {\r\n  let buffer = buf;\r\n\r\n  if (pad) {\r\n    buffer = buf.slice(APPMarkerLength);\r\n    const length = buffer.readUInt16BE(0);\r\n    buffer = buffer.slice(0, length);\r\n    const lengthLength = 2;\r\n    buffer = buffer.slice(lengthLength);\r\n    const identifierLength = 5;\r\n    buffer = buffer.slice(identifierLength);\r\n    const padLength = 1;\r\n    buffer = buffer.slice(padLength);\r\n  }\r\n\r\n  const byteOrderLength = 2;\r\n  const byteOrder = buffer.toString('ascii', 0, byteOrderLength) === 'MM';\r\n  const fortyTwoLength = 2;\r\n  const fortyTwoEnd = byteOrderLength + fortyTwoLength;\r\n  const big42 = buffer.readUInt32BE(fortyTwoEnd);\r\n  const little42 = buffer.readUInt32LE(fortyTwoEnd);\r\n  const offsetOfIFD = byteOrder ? big42 : little42;\r\n\r\n  buffer = buffer.slice(offsetOfIFD);\r\n\r\n  if (buffer.length > 0) {\r\n    data = IFDHandler(buffer, tags.ifd, byteOrder, offsetOfIFD);\r\n\r\n    if (data.ExifIFDPointer) {\r\n      buffer = buffer.slice(data.ExifIFDPointer - offsetOfIFD);\r\n      data.SubExif = IFDHandler(buffer, tags.ifd, byteOrder, data.ExifIFDPointer);\r\n    }\r\n\r\n    if (data.GPSInfoIFDPointer) {\r\n      const gps = data.GPSInfoIFDPointer;\r\n      buffer = buffer.slice(data.ExifIFDPointer ? gps - data.ExifIFDPointer : gps - offsetOfIFD);\r\n      data.GPSInfo = IFDHandler(buffer, tags.gps, byteOrder, gps);\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * @param buffer {Buffer}\r\n * @returns {Undefined}\r\n * @example\r\n * var content = fs.readFileSync(\"~/Picture/IMG_0911.JPG\");\r\n * var exifFragments = APPnHandler(content);\r\n */\r\nconst APPnHandler = (buffer) => {\r\n  const APPMarkerTag = checkAPPn(buffer);\r\n\r\n  if (APPMarkerTag !== false) { // APP0 is 0, and 0==false\r\n    const length = buffer.readUInt16BE(APPMarkerLength);\r\n\r\n    switch (APPMarkerTag) {\r\n      case 1: // EXIF\r\n        EXIFHandler(buffer);\r\n        break;\r\n      default:\r\n        APPnHandler(buffer.slice(APPMarkerLength + length));\r\n        break;\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * @param buffer {Buffer}\r\n * @returns {Object}\r\n * @example\r\n */\r\nconst fromBuffer = (buffer) => {\r\n  if (!buffer) {\r\n    throw new Error('buffer not found');\r\n  }\r\n\r\n  data = undefined;\r\n\r\n  if (isValid(buffer)) {\r\n    buffer = buffer.slice(SOIMarkerLength);\r\n    data = {};\r\n    APPnHandler(buffer);\r\n  } else if (isTiff(buffer)) {\r\n    data = {};\r\n    EXIFHandler(buffer, false);\r\n  }\r\n\r\n  return data;\r\n};\r\n\r\n/**\r\n * @param file {String}\r\n * @returns {Object}\r\n * @example\r\n * var exif = sync(\"~/Picture/IMG_1981.JPG\");\r\n * console.log(exif.createTime);\r\n */\r\nconst sync = (file) => {\r\n  if (!file) {\r\n    throw new Error('File not found');\r\n  }\r\n\r\n  const buffer = fs.readFileSync(file);\r\n\r\n  return fromBuffer(buffer);\r\n};\r\n\r\n/**\r\n * @param file {String}\r\n * @param callback {Function}\r\n * @example\r\n * async(\"~/Picture/IMG_0707.JPG\", (err, data) => {\r\n *     if(err) {\r\n *         console.log(err);\r\n *     }\r\n *     if(data) {\r\n *         console.log(data.ExifOffset.createTime);\r\n *     }\r\n * }\r\n */\r\nconst async = (file, callback) => {\r\n  data = undefined;\r\n\r\n  new Promise((resolve, reject) => {\r\n    if (!file) {\r\n      reject(new Error('❓File not found.'));\r\n    }\r\n\r\n    fs.readFile(file, (err, buffer) => {\r\n      if (err) {\r\n        reject(err);\r\n      } else {\r\n        try {\r\n          if (isValid(buffer)) {\r\n            const buf = buffer.slice(SOIMarkerLength);\r\n\r\n            data = {};\r\n\r\n            APPnHandler(buf);\r\n            resolve(data);\r\n          } else if (isTiff(buffer)) {\r\n            data = {};\r\n\r\n            EXIFHandler(buffer, false);\r\n            resolve(data);\r\n          } else {\r\n            reject(new Error('😱Unsupport file type.'));\r\n          }\r\n        } catch (e) {\r\n          reject(e);\r\n        }\r\n      }\r\n    });\r\n  }, (error) => {\r\n    callback(error, undefined);\r\n  }).then((d) => {\r\n    callback(undefined, d);\r\n  }).catch((error) => {\r\n    callback(error, undefined);\r\n  });\r\n};\r\n\r\nexports.fromBuffer = fromBuffer;\r\nexports.parse = async;\r\nexports.parseSync = sync;\r\n"]}